<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: NewRelic::Agent::Agent</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">NewRelic::Agent::Agent</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../files/vendor/plugins/newrelic_rpm/lib/newrelic/agent/agent_rb.html">
                vendor/plugins/newrelic_rpm/lib/newrelic/agent/agent.rb
                </a>
        <br />
                <a href="../../../files/vendor/plugins/newrelic_rpm/lib/newrelic/shim_agent_rb.html">
                vendor/plugins/newrelic_rpm/lib/newrelic/shim_agent.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
Implementation default for the <a href="../../NewRelic.html">NewRelic</a>
<a href="Agent.html">Agent</a>
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000073">ensure_started</a>&nbsp;&nbsp;
      <a href="#M000080">gather_info</a>&nbsp;&nbsp;
      <a href="#M000083">instance</a>&nbsp;&nbsp;
      <a href="#M000071">manual_start</a>&nbsp;&nbsp;
      <a href="#M000081">new</a>&nbsp;&nbsp;
      <a href="#M000082">new</a>&nbsp;&nbsp;
      <a href="#M000077">set_record_sql</a>&nbsp;&nbsp;
      <a href="#M000078">set_record_tt</a>&nbsp;&nbsp;
      <a href="#M000079">set_sql_obfuscator</a>&nbsp;&nbsp;
      <a href="#M000075">shutdown</a>&nbsp;&nbsp;
      <a href="#M000072">start</a>&nbsp;&nbsp;
      <a href="#M000074">start_reporting</a>&nbsp;&nbsp;
      <a href="#M000076">start_transaction</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->
    <div id="includes">
      <h3 class="section-bar">Included Modules</h3>

      <div id="includes-list">
        <span class="include-name">Singleton</span>
      </div>
    </div>

    <div id="section">


    <div id="constants-list">
      <h3 class="section-bar">Constants</h3>

      <div class="name-list">
        <table summary="Constants">
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">PROTOCOL_VERSION</td>
          <td>=</td>
          <td class="context-item-value">4</td>
          <td width="3em">&nbsp;</td>
          <td class="context-item-desc">
Specifies the version of the agent&#8216;s communication protocol with the
<a href="../../NewRelic.html">NewRelic</a> hosted site.

<p>
VERSION HISTORY 1: Private Beta, Jan 10, 2008. Serialized Marshalled
Objects. Unsupported after 5/29/2008. 2: Private Beta, March 15, 2008.
Compressed Serialzed Marshalled Objects (15-20x smaller) 3: June 19, 2008.
Added transaction sampler capability with obfuscation 4: July 15, 2008.
Added error capture
</p>
</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">DEFAULT_HOST</td>
          <td>=</td>
          <td class="context-item-value">'localhost'</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">DEFAULT_PORT</td>
          <td>=</td>
          <td class="context-item-value">3000</td>
        </tr>
        </table>
      </div>
    </div>



    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">config</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc">
Config hash

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">error_collector</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">identifier</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">license_key</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">log</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">obfuscator</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">record_sql</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">remote_host</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">remote_port</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">stats_engine</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">transaction_sampler</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">worker_loop</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000083" class="method-detail">
        <a name="M000083"></a>

        <div class="method-heading">
          <a href="#M000083" class="method-signature">
          <span class="method-name">instance</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000083-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000083-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/shim_agent.rb, line 68</span>
68:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">instance</span>
69:         <span class="ruby-ivar">@@agent</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">new</span>
70:         
71:         <span class="ruby-ivar">@@agent</span>
72:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000081" class="method-detail">
        <a name="M000081"></a>

        <div class="method-heading">
          <a href="#M000081" class="method-signature">
          <span class="method-name">new</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000081-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000081-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/agent.rb, line 359</span>
359:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>
360:       <span class="ruby-ivar">@connected</span> = <span class="ruby-keyword kw">false</span>
361:       <span class="ruby-ivar">@launch_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
362:       
363:       <span class="ruby-ivar">@metric_ids</span> = {}
364:       <span class="ruby-ivar">@environment</span> = <span class="ruby-identifier">:unknown</span>
365:       
366:       <span class="ruby-ivar">@stats_engine</span> = <span class="ruby-constant">StatsEngine</span>.<span class="ruby-identifier">new</span>
367:       <span class="ruby-ivar">@transaction_sampler</span> = <span class="ruby-constant">TransactionSampler</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>)
368:       <span class="ruby-ivar">@error_collector</span> = <span class="ruby-constant">ErrorCollector</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>)
369:       
370:       <span class="ruby-ivar">@request_timeout</span> = <span class="ruby-value">15</span> <span class="ruby-operator">*</span> <span class="ruby-value">60</span>
371:       
372:       <span class="ruby-ivar">@invalid_license</span> = <span class="ruby-keyword kw">false</span>
373:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000082" class="method-detail">
        <a name="M000082"></a>

        <div class="method-heading">
          <a href="#M000082" class="method-signature">
          <span class="method-name">new</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000082-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000082-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/shim_agent.rb, line 64</span>
64:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>
65:         <span class="ruby-ivar">@error_collector</span> = <span class="ruby-constant">ErrorCollector</span>.<span class="ruby-identifier">new</span>
66:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000073" class="method-detail">
        <a name="M000073"></a>

        <div class="method-heading">
          <a href="#M000073" class="method-signature">
          <span class="method-name">ensure_started</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
this method makes sure that the agent is running. it&#8216;s important for
passenger where processes are forked and the agent is dormant
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000073-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000073-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/agent.rb, line 200</span>
200:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ensure_started</span>
201:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@prod_mode_enabled</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@invalid_license</span>
202:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@worker_thread</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@worker_thread</span>.<span class="ruby-identifier">alive?</span>
203:         <span class="ruby-identifier">launch_worker_thread</span>
204:         <span class="ruby-ivar">@stats_engine</span>.<span class="ruby-identifier">spawn_sampler_thread</span>
205:      <span class="ruby-keyword kw">end</span>
206:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000080" class="method-detail">
        <a name="M000080"></a>

        <div class="method-heading">
          <a href="#M000080" class="method-signature">
          <span class="method-name">gather_info</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Collect the Rails::Info into an associative array as well as the list of
plugins
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000080-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000080-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/agent.rb, line 336</span>
336:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gather_info</span>
337:       <span class="ruby-identifier">i</span> = []
338:       <span class="ruby-keyword kw">begin</span> 
339:         <span class="ruby-identifier">require</span> <span class="ruby-value str">'builtin/rails_info/rails/info'</span>
340:         <span class="ruby-identifier">i</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Rails</span><span class="ruby-operator">::</span><span class="ruby-constant">Info</span>.<span class="ruby-identifier">properties</span>
341:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
342:         <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Unable to get the Rails info: #{e.inspect}&quot;</span>
343:         <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;\n&quot;</span>)
344:       <span class="ruby-keyword kw">end</span>
345:       <span class="ruby-comment cmt"># Would like to get this from config, but how?</span>
346:       <span class="ruby-identifier">plugins</span> = <span class="ruby-constant">Dir</span>[<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-keyword kw">__FILE__</span><span class="ruby-operator">+</span><span class="ruby-value str">&quot;/../../../../..&quot;</span>),<span class="ruby-value str">&quot;/*&quot;</span>)].<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span> <span class="ruby-identifier">p</span> }
347:       <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-value str">'Plugin List'</span>, <span class="ruby-identifier">plugins</span>]
348:       
349:       <span class="ruby-comment cmt"># Look for a capistrano file indicating the current revision:</span>
350:       <span class="ruby-identifier">rev_file</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">expand_path</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">RAILS_ROOT</span>, <span class="ruby-value str">&quot;REVISION&quot;</span>))
351:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">readable?</span>(<span class="ruby-identifier">rev_file</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">size</span>(<span class="ruby-identifier">rev_file</span>) <span class="ruby-operator">&lt;</span> <span class="ruby-value">64</span>
352:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">rev_file</span>) { <span class="ruby-operator">|</span> <span class="ruby-identifier">file</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-value str">'Revision'</span>, <span class="ruby-identifier">file</span>.<span class="ruby-identifier">read</span>] } <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
353:       <span class="ruby-keyword kw">end</span>
354:       <span class="ruby-identifier">i</span>
355:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000071" class="method-detail">
        <a name="M000071"></a>

        <div class="method-heading">
          <a href="#M000071" class="method-signature">
          <span class="method-name">manual_start</span><span class="method-args">(environment, identifier)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This method is deprecated. Use <a href="Agent.html#M000072">start</a>.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000071-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000071-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/agent.rb, line 164</span>
164:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">manual_start</span>(<span class="ruby-identifier">environment</span>, <span class="ruby-identifier">identifier</span>)
165:       <span class="ruby-identifier">start</span>(<span class="ruby-identifier">environment</span>, <span class="ruby-identifier">identifier</span>, <span class="ruby-keyword kw">true</span>)
166:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000077" class="method-detail">
        <a name="M000077"></a>

        <div class="method-heading">
          <a href="#M000077" class="method-signature">
          <span class="method-name">set_record_sql</span><span class="method-args">(should_record)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000077-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000077-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/agent.rb, line 309</span>
309:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_record_sql</span>(<span class="ruby-identifier">should_record</span>)
310:       <span class="ruby-identifier">prev</span> = <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:record_sql</span>]
311:       <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:record_sql</span>] = <span class="ruby-identifier">should_record</span>
312:       
313:       <span class="ruby-identifier">prev</span> <span class="ruby-operator">||</span> <span class="ruby-keyword kw">true</span>
314:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000078" class="method-detail">
        <a name="M000078"></a>

        <div class="method-heading">
          <a href="#M000078" class="method-signature">
          <span class="method-name">set_record_tt</span><span class="method-args">(should_record)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000078-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000078-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/agent.rb, line 316</span>
316:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_record_tt</span>(<span class="ruby-identifier">should_record</span>)
317:       <span class="ruby-identifier">prev</span> = <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:record_tt</span>]
318:       <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:record_tt</span>] = <span class="ruby-identifier">should_record</span>
319:       
320:       <span class="ruby-identifier">prev</span> <span class="ruby-operator">||</span> <span class="ruby-keyword kw">true</span>
321:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000079" class="method-detail">
        <a name="M000079"></a>

        <div class="method-heading">
          <a href="#M000079" class="method-signature">
          <span class="method-name">set_sql_obfuscator</span><span class="method-args">(type, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000079-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000079-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/agent.rb, line 323</span>
323:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_sql_obfuscator</span>(<span class="ruby-identifier">type</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
324:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:before</span>
325:         <span class="ruby-ivar">@obfuscator</span> = <span class="ruby-constant">ChainedCall</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">block</span>, <span class="ruby-ivar">@obfuscator</span>)
326:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:after</span>
327:         <span class="ruby-ivar">@obfuscator</span> = <span class="ruby-constant">ChainedCall</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@obfuscator</span>, <span class="ruby-identifier">block</span>)
328:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:replace</span>
329:         <span class="ruby-ivar">@obfuscator</span> = <span class="ruby-identifier">block</span>
330:       <span class="ruby-keyword kw">else</span>
331:         <span class="ruby-identifier">fail</span> <span class="ruby-node">&quot;unknown sql_obfuscator type #{type}&quot;</span>
332:       <span class="ruby-keyword kw">end</span>
333:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000075" class="method-detail">
        <a name="M000075"></a>

        <div class="method-heading">
          <a href="#M000075" class="method-signature">
          <span class="method-name">shutdown</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Attempt a graceful <a href="Agent.html#M000075">shutdown</a> of the agent.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000075-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000075-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/agent.rb, line 277</span>
277:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">shutdown</span>
278:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span> <span class="ruby-ivar">@started</span>
279:       <span class="ruby-ivar">@worker_loop</span>.<span class="ruby-identifier">stop</span>
280:       
281:       <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;Starting Agent shutdown&quot;</span>
282:       
283:       <span class="ruby-comment cmt"># if litespeed, then ignore all future SIGUSR1 - it's litespeed trying to shut us down</span>
284:       
285:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@environment</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:litespeed</span>
286:         <span class="ruby-constant">Signal</span>.<span class="ruby-identifier">trap</span>(<span class="ruby-value str">&quot;SIGUSR1&quot;</span>, <span class="ruby-value str">&quot;IGNORE&quot;</span>)
287:         <span class="ruby-constant">Signal</span>.<span class="ruby-identifier">trap</span>(<span class="ruby-value str">&quot;SIGTERM&quot;</span>, <span class="ruby-value str">&quot;IGNORE&quot;</span>)
288:       <span class="ruby-keyword kw">end</span>
289:       
290:       <span class="ruby-keyword kw">begin</span>
291:         
292:         <span class="ruby-comment cmt"># only call graceful_disconnect if we successfully stop the worker thread (since a transaction may be in flight)</span>
293:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@worker_thread</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value">30</span>)  
294:           <span class="ruby-identifier">graceful_disconnect</span>
295:         <span class="ruby-keyword kw">else</span>
296:           <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-value str">&quot;ERROR - could not stop worker thread&quot;</span>
297:         <span class="ruby-keyword kw">end</span>
298:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
299:         <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-identifier">e</span>
300:         <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;\n&quot;</span>)
301:       <span class="ruby-keyword kw">end</span>
302:       <span class="ruby-ivar">@started</span> = <span class="ruby-keyword kw">nil</span>
303:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000072" class="method-detail">
        <a name="M000072"></a>

        <div class="method-heading">
          <a href="#M000072" class="method-signature">
          <span class="method-name">start</span><span class="method-args">(environment, identifier, force=false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Start up the agent, which will connect to the newrelic server and <a
href="Agent.html#M000072">start</a> reporting performance information.
Typically this is done from the environment configuration file. environment
identifies the host environment, like mongrel, thin, or take. identifier is
an identifier which uniquely identifies the process hosting the agent. It
should be ideally something like a server port, like 3000, a handler thread
name, or a script name. It should not be a PID because that will change
from invocation to invocation. For something like rake, you could use the
task name. Return false if the agent was not started
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000072-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000072-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/agent.rb, line 179</span>
179:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start</span>(<span class="ruby-identifier">environment</span>, <span class="ruby-identifier">identifier</span>, <span class="ruby-identifier">force</span>=<span class="ruby-keyword kw">false</span>)
180: 
181:       <span class="ruby-ivar">@config</span> <span class="ruby-operator">||=</span> <span class="ruby-operator">::</span><span class="ruby-constant">NR_CONFIG_FILE</span> 
182:       
183:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@started</span>
184:         <span class="ruby-identifier">log!</span> <span class="ruby-value str">&quot;Agent Started Already!&quot;</span>
185:         <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;Duplicate attempt to start the NewRelic agent&quot;</span>
186:       <span class="ruby-keyword kw">end</span>
187:       <span class="ruby-ivar">@environment</span> = <span class="ruby-identifier">environment</span>
188:       <span class="ruby-ivar">@identifier</span> = <span class="ruby-identifier">identifier</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">identifier</span>.<span class="ruby-identifier">to_s</span>
189:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@identifier</span>
190:         <span class="ruby-identifier">start_reporting</span>(<span class="ruby-identifier">force</span>)
191:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">true</span>
192:       <span class="ruby-keyword kw">else</span>
193:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span>
194:       <span class="ruby-keyword kw">end</span>
195:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000074" class="method-detail">
        <a name="M000074"></a>

        <div class="method-heading">
          <a href="#M000074" class="method-signature">
          <span class="method-name">start_reporting</span><span class="method-args">(force_enable=false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000074-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000074-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/agent.rb, line 208</span>
208:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_reporting</span>(<span class="ruby-identifier">force_enable</span>=<span class="ruby-keyword kw">false</span>)
209:       <span class="ruby-ivar">@local_host</span> = <span class="ruby-identifier">determine_host</span>
210: 
211:       <span class="ruby-identifier">setup_log</span>
212:       
213:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@environment</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:passenger</span>
214:         <span class="ruby-identifier">log</span>.<span class="ruby-identifier">warn</span> <span class="ruby-value str">&quot;Phusion Passenger has been detected. Some RPM memory statistics may have inaccuracies due to short process lifespans&quot;</span>
215:       <span class="ruby-keyword kw">end</span>
216:       
217:       <span class="ruby-ivar">@worker_loop</span> = <span class="ruby-constant">WorkerLoop</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@log</span>)
218:       <span class="ruby-ivar">@started</span> = <span class="ruby-keyword kw">true</span>
219:       
220:       <span class="ruby-ivar">@license_key</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'license_key'</span>, <span class="ruby-keyword kw">nil</span>)
221:       
222:       <span class="ruby-identifier">ignore_errors</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'ignore_errors'</span>, <span class="ruby-value str">&quot;&quot;</span>)
223:       <span class="ruby-identifier">ignore_errors</span> = <span class="ruby-identifier">ignore_errors</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;,&quot;</span>)
224:       <span class="ruby-identifier">ignore_errors</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">error</span><span class="ruby-operator">|</span> <span class="ruby-identifier">error</span>.<span class="ruby-identifier">strip!</span> } 
225:       
226:       <span class="ruby-ivar">@error_collector</span>.<span class="ruby-identifier">ignore</span>(<span class="ruby-identifier">ignore_errors</span>)
227:       <span class="ruby-ivar">@capture_params</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'capture_params'</span>, <span class="ruby-keyword kw">false</span>)
228:             
229:       <span class="ruby-identifier">sampler_config</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'transaction_tracer'</span>, {})
230:       
231:       <span class="ruby-ivar">@use_transaction_sampler</span> = <span class="ruby-identifier">sampler_config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'enabled'</span>, <span class="ruby-keyword kw">false</span>)
232:       <span class="ruby-ivar">@record_sql</span> = (<span class="ruby-identifier">sampler_config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'record_sql'</span>, <span class="ruby-value str">'obfuscated'</span>) <span class="ruby-operator">||</span> <span class="ruby-value str">'off'</span>).<span class="ruby-identifier">intern</span>
233:       <span class="ruby-ivar">@slowest_transaction_threshold</span> = <span class="ruby-identifier">sampler_config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'transaction_threshold'</span>, <span class="ruby-value str">'2.0'</span>).<span class="ruby-identifier">to_f</span>
234:       <span class="ruby-ivar">@explain_threshold</span> = <span class="ruby-identifier">sampler_config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'explain_threshold'</span>, <span class="ruby-value str">'0.5'</span>).<span class="ruby-identifier">to_f</span>
235:       <span class="ruby-ivar">@explain_enabled</span> = <span class="ruby-identifier">sampler_config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'explain_enabled'</span>, <span class="ruby-keyword kw">true</span>)
236:       
237:       <span class="ruby-identifier">log</span>.<span class="ruby-identifier">info</span> <span class="ruby-value str">&quot;Transaction tracing is enabled in the agent&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@use_transaction_sampler</span>
238:       <span class="ruby-identifier">log</span>.<span class="ruby-identifier">warn</span> <span class="ruby-value str">&quot;Agent is configured to send raw SQL to RPM service&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@record_sql</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:raw</span>
239:       
240:       <span class="ruby-ivar">@use_ssl</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'ssl'</span>, <span class="ruby-keyword kw">false</span>)
241:       <span class="ruby-identifier">default_port</span> = <span class="ruby-ivar">@use_ssl</span> <span class="ruby-operator">?</span> <span class="ruby-value">443</span> <span class="ruby-operator">:</span> <span class="ruby-value">80</span>
242:       
243:       <span class="ruby-ivar">@remote_host</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'host'</span>, <span class="ruby-value str">'collector.newrelic.com'</span>)
244:       <span class="ruby-ivar">@remote_port</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'port'</span>, <span class="ruby-identifier">default_port</span>)
245:       
246:       <span class="ruby-ivar">@proxy_host</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'proxy_host'</span>, <span class="ruby-keyword kw">nil</span>)
247:       <span class="ruby-ivar">@proxy_port</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'proxy_port'</span>, <span class="ruby-keyword kw">nil</span>)
248:       <span class="ruby-ivar">@proxy_user</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'proxy_user'</span>, <span class="ruby-keyword kw">nil</span>)
249:       <span class="ruby-ivar">@proxy_pass</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value str">'proxy_pass'</span>, <span class="ruby-keyword kw">nil</span>)
250: 
251:       <span class="ruby-ivar">@prod_mode_enabled</span> = <span class="ruby-identifier">force_enable</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">config</span>[<span class="ruby-value str">'enabled'</span>]
252:       
253:       <span class="ruby-comment cmt"># Initialize transaction sampler</span>
254:       <span class="ruby-ivar">@transaction_sampler</span>.<span class="ruby-identifier">capture_params</span> = <span class="ruby-ivar">@capture_params</span>
255:       <span class="ruby-ivar">@error_collector</span>.<span class="ruby-identifier">capture_params</span> = <span class="ruby-ivar">@capture_params</span>
256: 
257:       
258:       <span class="ruby-comment cmt"># make sure the license key exists and is likely to be really a license key</span>
259:       <span class="ruby-comment cmt"># by checking it's string length (license keys are 40 character strings.)</span>
260:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@prod_mode_enabled</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-operator">!</span><span class="ruby-ivar">@license_key</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@license_key</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">!=</span> <span class="ruby-value">40</span>)
261:         <span class="ruby-identifier">log!</span> <span class="ruby-value str">&quot;No license key found.  Please insert your license key into agent/newrelic.yml&quot;</span>
262:         <span class="ruby-keyword kw">return</span>
263:       <span class="ruby-keyword kw">end</span>
264: 
265:       <span class="ruby-identifier">instrument_rails</span>
266:       
267:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@prod_mode_enabled</span>
268:         <span class="ruby-identifier">load_samplers</span>
269:         <span class="ruby-identifier">launch_worker_thread</span>
270:         <span class="ruby-comment cmt"># When the VM shuts down, attempt to send a message to the server that</span>
271:         <span class="ruby-comment cmt"># this agent run is stopping, assuming it has successfully connected</span>
272:         <span class="ruby-identifier">at_exit</span> { <span class="ruby-identifier">shutdown</span> }
273:       <span class="ruby-keyword kw">end</span>
274:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000076" class="method-detail">
        <a name="M000076"></a>

        <div class="method-heading">
          <a href="#M000076" class="method-signature">
          <span class="method-name">start_transaction</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000076-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000076-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/agent.rb, line 305</span>
305:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_transaction</span>
306:       <span class="ruby-ivar">@stats_engine</span>.<span class="ruby-identifier">start_transaction</span>
307:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>