<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: NewRelic::Agent::StatsEngine</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">NewRelic::Agent::StatsEngine</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../files/vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine_rb.html">
                vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000062">add_sampled_metric</a>&nbsp;&nbsp;
      <a href="#M000058">add_scope_stack_listener</a>&nbsp;&nbsp;
      <a href="#M000066">get_stats</a>&nbsp;&nbsp;
      <a href="#M000067">harvest_timeslice_data</a>&nbsp;&nbsp;
      <a href="#M000065">lookup_stat</a>&nbsp;&nbsp;
      <a href="#M000056">new</a>&nbsp;&nbsp;
      <a href="#M000061">peek_scope</a>&nbsp;&nbsp;
      <a href="#M000060">pop_scope</a>&nbsp;&nbsp;
      <a href="#M000059">push_scope</a>&nbsp;&nbsp;
      <a href="#M000057">spawn_sampler_thread</a>&nbsp;&nbsp;
      <a href="#M000068">start_transaction</a>&nbsp;&nbsp;
      <a href="#M000064">transaction_name</a>&nbsp;&nbsp;
      <a href="#M000063">transaction_name=</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">

    <div id="class-list">
      <h3 class="section-bar">Classes and Modules</h3>

      Class <a href="StatsEngine/SampledItem.html" class="link">NewRelic::Agent::StatsEngine::SampledItem</a><br />

    </div>

    <div id="constants-list">
      <h3 class="section-bar">Constants</h3>

      <div class="name-list">
        <table summary="Constants">
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">POLL_PERIOD</td>
          <td>=</td>
          <td class="context-item-value">10</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">ScopeStackElement</td>
          <td>=</td>
          <td class="context-item-value">Struct.new(:name, :timestamp, :children_time, :deduct_call_time_from_parent)</td>
        </tr>
        </table>
      </div>
    </div>



    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">log</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000056" class="method-detail">
        <a name="M000056"></a>

        <div class="method-heading">
          <a href="#M000056" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(log = Logger.new(STDERR))</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000056-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000056-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine.rb, line 24</span>
24:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">log</span> = <span class="ruby-constant">Logger</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">STDERR</span>))
25:       <span class="ruby-ivar">@stats_hash</span> = {}
26:       <span class="ruby-ivar">@sampled_items</span> = []
27:       <span class="ruby-ivar">@scope_stack_listeners</span> = []
28:       <span class="ruby-ivar">@log</span> = <span class="ruby-identifier">log</span>
29:       
30:       <span class="ruby-comment cmt"># Makes the unit tests happy</span>
31:       <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_stack</span>] = <span class="ruby-keyword kw">nil</span>
32:       
33:       <span class="ruby-identifier">spawn_sampler_thread</span>
34:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000062" class="method-detail">
        <a name="M000062"></a>

        <div class="method-heading">
          <a href="#M000062" class="method-signature">
          <span class="method-name">add_sampled_metric</span><span class="method-args">(metric_name, &amp;sampler_callback)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000062-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000062-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine.rb, line 106</span>
106:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_sampled_metric</span>(<span class="ruby-identifier">metric_name</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">sampler_callback</span>)
107:       <span class="ruby-identifier">stats</span> = <span class="ruby-identifier">get_stats</span>(<span class="ruby-identifier">metric_name</span>, <span class="ruby-keyword kw">false</span>)
108:       <span class="ruby-ivar">@sampled_items</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">SampledItem</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">stats</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">sampler_callback</span>)
109:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000058" class="method-detail">
        <a name="M000058"></a>

        <div class="method-heading">
          <a href="#M000058" class="method-signature">
          <span class="method-name">add_scope_stack_listener</span><span class="method-args">(l)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000058-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000058-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine.rb, line 62</span>
62:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_scope_stack_listener</span>(<span class="ruby-identifier">l</span>)
63:       <span class="ruby-identifier">fail</span> <span class="ruby-value str">&quot;Can't add a scope listener midflight in a transaction&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope_stack</span>.<span class="ruby-identifier">any?</span>
64:       <span class="ruby-ivar">@scope_stack_listeners</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">l</span>
65:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000066" class="method-detail">
        <a name="M000066"></a>

        <div class="method-heading">
          <a href="#M000066" class="method-signature">
          <span class="method-name">get_stats</span><span class="method-args">(metric_name, use_scope = true)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000066-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000066-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine.rb, line 132</span>
132:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_stats</span>(<span class="ruby-identifier">metric_name</span>, <span class="ruby-identifier">use_scope</span> = <span class="ruby-keyword kw">true</span>)
133:       <span class="ruby-identifier">spec</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">MetricSpec</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">metric_name</span>
134:       <span class="ruby-identifier">stats</span> = <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">spec</span>]
135:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stats</span>.<span class="ruby-identifier">nil?</span>
136:         <span class="ruby-identifier">stats</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">MethodTraceStats</span>.<span class="ruby-identifier">new</span>
137:         <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">spec</span>] = <span class="ruby-identifier">stats</span>
138:       <span class="ruby-keyword kw">end</span>
139:       
140:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">use_scope</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">transaction_name</span>
141:         <span class="ruby-identifier">spec</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">MetricSpec</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">metric_name</span>, <span class="ruby-identifier">transaction_name</span>
142:         
143:         <span class="ruby-identifier">scoped_stats</span> = <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">spec</span>]
144:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scoped_stats</span>.<span class="ruby-identifier">nil?</span>
145:           <span class="ruby-identifier">scoped_stats</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">ScopedMethodTraceStats</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">stats</span>
146:           <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">spec</span>] = <span class="ruby-identifier">scoped_stats</span>        
147:         <span class="ruby-keyword kw">end</span>
148:         
149:         <span class="ruby-identifier">stats</span> = <span class="ruby-identifier">scoped_stats</span>
150:       <span class="ruby-keyword kw">end</span>
151:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">stats</span>
152:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000067" class="method-detail">
        <a name="M000067"></a>

        <div class="method-heading">
          <a href="#M000067" class="method-signature">
          <span class="method-name">harvest_timeslice_data</span><span class="method-args">(previous_timeslice_data, metric_ids)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000067-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000067-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine.rb, line 154</span>
154:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">harvest_timeslice_data</span>(<span class="ruby-identifier">previous_timeslice_data</span>, <span class="ruby-identifier">metric_ids</span>)
155:       <span class="ruby-identifier">timeslice_data</span> = {}
156:       
157:       <span class="ruby-ivar">@stats_hash</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">metric_spec</span><span class="ruby-operator">|</span>
158:         
159:         <span class="ruby-comment cmt"># get a copy of the stats collected since the last harvest, and clear</span>
160:         <span class="ruby-comment cmt"># the stats inside our hash table for the next time slice.</span>
161:         <span class="ruby-identifier">stats</span> = <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-identifier">metric_spec</span>]
162:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stats</span>.<span class="ruby-identifier">nil?</span> 
163:           <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Nil stats for #{metric_spec.name} (#{metric_spec.scope})&quot;</span>
164:         <span class="ruby-keyword kw">end</span>
165:         
166:         <span class="ruby-identifier">stats_copy</span> = <span class="ruby-identifier">stats</span>.<span class="ruby-identifier">clone</span>
167:         <span class="ruby-identifier">stats</span>.<span class="ruby-identifier">reset</span>
168:         
169:         <span class="ruby-comment cmt"># if the previous timeslice data has not been reported (due to an error of some sort)</span>
170:         <span class="ruby-comment cmt"># then we need to merge this timeslice with the previously accumulated - but not sent</span>
171:         <span class="ruby-comment cmt"># data</span>
172:         <span class="ruby-identifier">previous_metric_data</span> = <span class="ruby-identifier">previous_timeslice_data</span>[<span class="ruby-identifier">metric_spec</span>]
173:         <span class="ruby-identifier">stats_copy</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">previous_metric_data</span>.<span class="ruby-identifier">stats</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">previous_metric_data</span>.<span class="ruby-identifier">nil?</span>
174:         
175:         <span class="ruby-identifier">stats_copy</span>.<span class="ruby-identifier">round!</span>
176:         
177:         <span class="ruby-comment cmt"># don't bother collecting and reporting stats that have zero-values for this timeslice.</span>
178:         <span class="ruby-comment cmt"># significant performance boost and storage savings.</span>
179:         <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">stats_copy</span>.<span class="ruby-identifier">call_count</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
180:           
181:           <span class="ruby-identifier">metric_spec_for_transport</span> = (<span class="ruby-identifier">metric_ids</span>[<span class="ruby-identifier">metric_spec</span>].<span class="ruby-identifier">nil?</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">metric_spec</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>
182:           
183:           <span class="ruby-identifier">metric_data</span> = <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">MetricData</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">metric_spec_for_transport</span>, <span class="ruby-identifier">stats_copy</span>, <span class="ruby-identifier">metric_ids</span>[<span class="ruby-identifier">metric_spec</span>])
184:           
185:           <span class="ruby-identifier">timeslice_data</span>[<span class="ruby-identifier">metric_spec</span>] = <span class="ruby-identifier">metric_data</span>
186:         <span class="ruby-keyword kw">end</span>
187:       <span class="ruby-keyword kw">end</span>
188:       
189:       <span class="ruby-identifier">timeslice_data</span>
190:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000065" class="method-detail">
        <a name="M000065"></a>

        <div class="method-heading">
          <a href="#M000065" class="method-signature">
          <span class="method-name">lookup_stat</span><span class="method-args">(metric_name)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000065-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000065-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine.rb, line 128</span>
128:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">lookup_stat</span>(<span class="ruby-identifier">metric_name</span>)
129:       <span class="ruby-keyword kw">return</span> <span class="ruby-ivar">@stats_hash</span>[<span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">MetricSpec</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">metric_name</span>)]
130:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000061" class="method-detail">
        <a name="M000061"></a>

        <div class="method-heading">
          <a href="#M000061" class="method-signature">
          <span class="method-name">peek_scope</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000061-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000061-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine.rb, line 102</span>
102:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">peek_scope</span>
103:       <span class="ruby-identifier">scope_stack</span>.<span class="ruby-identifier">last</span>
104:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000060" class="method-detail">
        <a name="M000060"></a>

        <div class="method-heading">
          <a href="#M000060" class="method-signature">
          <span class="method-name">pop_scope</span><span class="method-args">(expected_scope, duration = Time.now - expected_scope.timestamp)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000060-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000060-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine.rb, line 79</span>
 79:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pop_scope</span>(<span class="ruby-identifier">expected_scope</span>, <span class="ruby-identifier">duration</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">expected_scope</span>.<span class="ruby-identifier">timestamp</span>)
 80:       <span class="ruby-identifier">stack</span> = <span class="ruby-identifier">scope_stack</span>
 81:       
 82:       <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">pop</span>
 83:       
 84:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">expected_scope</span>
 85:               <span class="ruby-identifier">fail</span> <span class="ruby-node">&quot;unbalanced pop from blame stack: #{scope.name} != #{expected_scope.name}&quot;</span>
 86:       <span class="ruby-keyword kw">end</span>
 87:       
 88:       <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">children_time</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">duration</span> <span class="ruby-keyword kw">unless</span> (<span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">scope</span>.<span class="ruby-identifier">deduct_call_time_from_parent</span>)
 89:       
 90:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">scope</span>.<span class="ruby-identifier">deduct_call_time_from_parent</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span>
 91:         <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">children_time</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">children_time</span>
 92:       <span class="ruby-keyword kw">end</span>
 93:       
 94:       <span class="ruby-ivar">@scope_stack_listeners</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">l</span><span class="ruby-operator">|</span>
 95:         <span class="ruby-identifier">l</span>.<span class="ruby-identifier">notice_pop_scope</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">name</span>
 96:         <span class="ruby-identifier">l</span>.<span class="ruby-identifier">notice_scope_empty</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope_stack</span>.<span class="ruby-identifier">empty?</span> 
 97:       <span class="ruby-keyword kw">end</span>
 98:       
 99:       <span class="ruby-identifier">scope</span>
100:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000059" class="method-detail">
        <a name="M000059"></a>

        <div class="method-heading">
          <a href="#M000059" class="method-signature">
          <span class="method-name">push_scope</span><span class="method-args">(metric, time = Time.now, deduct_call_time_from_parent = true)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000059-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000059-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine.rb, line 67</span>
67:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">push_scope</span>(<span class="ruby-identifier">metric</span>, <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>, <span class="ruby-identifier">deduct_call_time_from_parent</span> = <span class="ruby-keyword kw">true</span>)
68:       <span class="ruby-ivar">@scope_stack_listeners</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">l</span><span class="ruby-operator">|</span>
69:         <span class="ruby-identifier">l</span>.<span class="ruby-identifier">notice_first_scope_push</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope_stack</span>.<span class="ruby-identifier">empty?</span> 
70:         <span class="ruby-identifier">l</span>.<span class="ruby-identifier">notice_push_scope</span> <span class="ruby-identifier">metric</span>
71:       <span class="ruby-keyword kw">end</span>
72:       
73:       <span class="ruby-identifier">scope</span> = <span class="ruby-constant">ScopeStackElement</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">metric</span>, <span class="ruby-identifier">time</span>, <span class="ruby-value">0</span>, <span class="ruby-identifier">deduct_call_time_from_parent</span>)
74:       <span class="ruby-identifier">scope_stack</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">scope</span>
75:       
76:       <span class="ruby-identifier">scope</span>
77:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000057" class="method-detail">
        <a name="M000057"></a>

        <div class="method-heading">
          <a href="#M000057" class="method-signature">
          <span class="method-name">spawn_sampler_thread</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000057-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000057-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine.rb, line 36</span>
36:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">spawn_sampler_thread</span>
37:       
38:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@sampler_process</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@sampler_process</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">$$</span> 
39:       
40:       <span class="ruby-comment cmt"># start up a thread that will periodically poll for metric samples</span>
41:       <span class="ruby-ivar">@sampler_thread</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword kw">do</span>
42:         <span class="ruby-keyword kw">while</span> <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">do</span>
43:           <span class="ruby-keyword kw">begin</span>
44:             <span class="ruby-identifier">sleep</span> <span class="ruby-constant">POLL_PERIOD</span>
45:             <span class="ruby-ivar">@sampled_items</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">sampled_item</span><span class="ruby-operator">|</span>
46:               <span class="ruby-keyword kw">begin</span> 
47:                 <span class="ruby-identifier">sampled_item</span>.<span class="ruby-identifier">poll</span>
48:               <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
49:                 <span class="ruby-identifier">log</span>.<span class="ruby-identifier">error</span> <span class="ruby-identifier">e</span>
50:                 <span class="ruby-ivar">@sampled_items</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">sampled_item</span>
51:                 <span class="ruby-identifier">log</span>.<span class="ruby-identifier">error</span> <span class="ruby-node">&quot;Removing #{sampled_item} from list&quot;</span>
52:                 <span class="ruby-identifier">log</span>.<span class="ruby-identifier">debug</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">backtrace</span>.<span class="ruby-identifier">to_s</span>
53:               <span class="ruby-keyword kw">end</span>
54:             <span class="ruby-keyword kw">end</span>
55:           <span class="ruby-keyword kw">end</span>
56:         <span class="ruby-keyword kw">end</span>
57:       <span class="ruby-keyword kw">end</span>
58: 
59:       <span class="ruby-ivar">@sampler_process</span> = <span class="ruby-identifier">$$</span>
60:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000068" class="method-detail">
        <a name="M000068"></a>

        <div class="method-heading">
          <a href="#M000068" class="method-signature">
          <span class="method-name">start_transaction</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000068-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000068-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine.rb, line 193</span>
193:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_transaction</span>
194:       <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_stack</span>] = []
195:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000064" class="method-detail">
        <a name="M000064"></a>

        <div class="method-heading">
          <a href="#M000064" class="method-signature">
          <span class="method-name">transaction_name</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000064-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000064-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine.rb, line 123</span>
123:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">transaction_name</span>
124:       <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_transaction_name</span>]
125:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000063" class="method-detail">
        <a name="M000063"></a>

        <div class="method-heading">
          <a href="#M000063" class="method-signature">
          <span class="method-name">transaction_name=</span><span class="method-args">(transaction)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
set the name of the transaction for the current thread, which will be used
to define the scope of all traced methods called on this thread until the
scope stack is empty.
</p>
<p>
currently the transaction name is the name of the controller action that is
invoked via the dispatcher, but conceivably we could use other transaction
names in the future if the traced application does more than service http
request via controller actions
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000063-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000063-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/newrelic_rpm/lib/newrelic/agent/stats_engine.rb, line 119</span>
119:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">transaction_name=</span>(<span class="ruby-identifier">transaction</span>)
120:       <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_transaction_name</span>] = <span class="ruby-identifier">transaction</span>
121:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>