<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: ActsAsFerret::LocalIndex</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">ActsAsFerret::LocalIndex</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../files/vendor/plugins/acts_as_ferret/lib/local_index_rb.html">
                vendor/plugins/acts_as_ferret/lib/local_index.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                <a href="AbstractIndex.html">
                AbstractIndex
               </a>
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000119">&lt;&lt;</a>&nbsp;&nbsp;
      <a href="#M000118">add</a>&nbsp;&nbsp;
      <a href="#M000112">bulk_index</a>&nbsp;&nbsp;
      <a href="#M000110">close</a>&nbsp;&nbsp;
      <a href="#M000115">determine_lazy_fields</a>&nbsp;&nbsp;
      <a href="#M000122">document_number</a>&nbsp;&nbsp;
      <a href="#M000109">ensure_index_exists</a>&nbsp;&nbsp;
      <a href="#M000108">ferret_index</a>&nbsp;&nbsp;
      <a href="#M000116">find_id_by_contents</a>&nbsp;&nbsp;
      <a href="#M000121">highlight</a>&nbsp;&nbsp;
      <a href="#M000117">id_multi_search</a>&nbsp;&nbsp;
      <a href="#M000124">multi_index</a>&nbsp;&nbsp;
      <a href="#M000106">new</a>&nbsp;&nbsp;
      <a href="#M000113">process_query</a>&nbsp;&nbsp;
      <a href="#M000123">query_for_record</a>&nbsp;&nbsp;
      <a href="#M000111">rebuild_index</a>&nbsp;&nbsp;
      <a href="#M000120">remove</a>&nbsp;&nbsp;
      <a href="#M000107">reopen!</a>&nbsp;&nbsp;
      <a href="#M000114">total_hits</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->
    <div id="includes">
      <h3 class="section-bar">Included Modules</h3>

      <div id="includes-list">
        <span class="include-name"><a href="MoreLikeThis/IndexMethods.html">MoreLikeThis::IndexMethods</a></span>
      </div>
    </div>

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000106" class="method-detail">
        <a name="M000106"></a>

        <div class="method-heading">
          <a href="#M000106" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(aaf_configuration)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000106-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000106-source">
<pre>
   <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 5</span>
5:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">aaf_configuration</span>)
6:       <span class="ruby-keyword kw">super</span>
7:       <span class="ruby-identifier">ensure_index_exists</span>
8:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000119" class="method-detail">
        <a name="M000119"></a>

        <div class="method-heading">
          <span class="method-name">&lt;&lt;</span><span class="method-args">(record)</span>
        </div>
      
        <div class="method-description">
          <p>
Alias for <a href="LocalIndex.html#M000118">add</a>
</p>
        </div>
      </div>

      <div id="method-M000118" class="method-detail">
        <a name="M000118"></a>

        <div class="method-heading">
          <a href="#M000118" class="method-signature">
          <span class="method-name">add</span><span class="method-args">(record)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
<a href="LocalIndex.html#M000118">add</a> record to index record may be the
full AR object, a <a href="../Ferret.html">Ferret</a> document instance or
a Hash
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000118-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000118-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 152</span>
152:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add</span>(<span class="ruby-identifier">record</span>)
153:       <span class="ruby-identifier">record</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">to_doc</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">Hash</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">record</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Ferret</span><span class="ruby-operator">::</span><span class="ruby-constant">Document</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">record</span>
154:       <span class="ruby-identifier">ferret_index</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">record</span>
155:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000112" class="method-detail">
        <a name="M000112"></a>

        <div class="method-heading">
          <a href="#M000112" class="method-signature">
          <span class="method-name">bulk_index</span><span class="method-args">(ids, options)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000112-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000112-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 63</span>
63:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">bulk_index</span>(<span class="ruby-identifier">ids</span>, <span class="ruby-identifier">options</span>)
64:       <span class="ruby-identifier">ferret_index</span>.<span class="ruby-identifier">bulk_index</span>(<span class="ruby-identifier">aaf_configuration</span>[<span class="ruby-identifier">:class_name</span>].<span class="ruby-identifier">constantize</span>, <span class="ruby-identifier">ids</span>, <span class="ruby-identifier">options</span>)
65:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000110" class="method-detail">
        <a name="M000110"></a>

        <div class="method-heading">
          <a href="#M000110" class="method-signature">
          <span class="method-name">close</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Closes the underlying index instance
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000110-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000110-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 40</span>
40:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">close</span>
41:       <span class="ruby-ivar">@ferret_index</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@ferret_index</span>
42:     <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">StandardError</span> 
43:       <span class="ruby-comment cmt"># is raised when index already closed</span>
44:     <span class="ruby-keyword kw">ensure</span>
45:       <span class="ruby-ivar">@ferret_index</span> = <span class="ruby-keyword kw">nil</span>
46:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000115" class="method-detail">
        <a name="M000115"></a>

        <div class="method-heading">
          <a href="#M000115" class="method-signature">
          <span class="method-name">determine_lazy_fields</span><span class="method-args">(options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000115-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000115-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 85</span>
85:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">determine_lazy_fields</span>(<span class="ruby-identifier">options</span> = {})
86:       <span class="ruby-identifier">stored_fields</span> = <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:lazy</span>]
87:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stored_fields</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-constant">Array</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">stored_fields</span>)
88:         <span class="ruby-identifier">stored_fields</span> = <span class="ruby-identifier">aaf_configuration</span>[<span class="ruby-identifier">:ferret_fields</span>].<span class="ruby-identifier">select</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">field</span>, <span class="ruby-identifier">config</span><span class="ruby-operator">|</span> <span class="ruby-identifier">config</span>[<span class="ruby-identifier">:store</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">:yes</span> }.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:first</span>)
89:       <span class="ruby-keyword kw">end</span>
90:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;stored_fields: #{stored_fields}&quot;</span>
91:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">stored_fields</span>
92:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000122" class="method-detail">
        <a name="M000122"></a>

        <div class="method-heading">
          <a href="#M000122" class="method-signature">
          <span class="method-name">document_number</span><span class="method-args">(id, class_name)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
retrieves the ferret document number of the record with the given id.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000122-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000122-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 184</span>
184:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">document_number</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">class_name</span>)
185:       <span class="ruby-identifier">hits</span> = <span class="ruby-identifier">ferret_index</span>.<span class="ruby-identifier">search</span>(<span class="ruby-identifier">query_for_record</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">class_name</span>))
186:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">hits</span>.<span class="ruby-identifier">hits</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">doc</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">hits</span>.<span class="ruby-identifier">total_hits</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
187:       <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;cannot determine document number from primary key: #{id}&quot;</span>
188:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000109" class="method-detail">
        <a name="M000109"></a>

        <div class="method-heading">
          <a href="#M000109" class="method-signature">
          <span class="method-name">ensure_index_exists</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Checks for the presence of a segments file in the index directory Rebuilds
the index if none exists.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000109-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000109-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 30</span>
30:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ensure_index_exists</span>
31:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;LocalIndex: ensure_index_exists at #{aaf_configuration[:index_dir]}&quot;</span>
32:       <span class="ruby-keyword kw">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">file?</span> <span class="ruby-node">&quot;#{aaf_configuration[:index_dir]}/segments&quot;</span>
33:         <span class="ruby-constant">ActsAsFerret</span><span class="ruby-operator">::</span><span class="ruby-identifier">ensure_directory</span>(<span class="ruby-identifier">aaf_configuration</span>[<span class="ruby-identifier">:index_dir</span>])
34:         <span class="ruby-identifier">close</span>
35:         <span class="ruby-identifier">rebuild_index</span> 
36:       <span class="ruby-keyword kw">end</span>
37:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000108" class="method-detail">
        <a name="M000108"></a>

        <div class="method-heading">
          <a href="#M000108" class="method-signature">
          <span class="method-name">ferret_index</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
The &#8216;real&#8217; <a href="../Ferret.html">Ferret</a> Index instance
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000108-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000108-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 20</span>
20:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ferret_index</span>
21:       <span class="ruby-identifier">ensure_index_exists</span>
22:       <span class="ruby-identifier">returning</span> <span class="ruby-ivar">@ferret_index</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Ferret</span><span class="ruby-operator">::</span><span class="ruby-constant">Index</span><span class="ruby-operator">::</span><span class="ruby-constant">Index</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">aaf_configuration</span>[<span class="ruby-identifier">:ferret</span>]) <span class="ruby-keyword kw">do</span>
23:         <span class="ruby-ivar">@ferret_index</span>.<span class="ruby-identifier">batch_size</span> = <span class="ruby-identifier">aaf_configuration</span>[<span class="ruby-identifier">:reindex_batch_size</span>]
24:         <span class="ruby-ivar">@ferret_index</span>.<span class="ruby-identifier">logger</span> = <span class="ruby-identifier">logger</span>
25:       <span class="ruby-keyword kw">end</span>
26:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000116" class="method-detail">
        <a name="M000116"></a>

        <div class="method-heading">
          <a href="#M000116" class="method-signature">
          <span class="method-name">find_id_by_contents</span><span class="method-args">(query, options = {}) {|model, doc[:id], score, data| ...}</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Queries the <a href="../Ferret.html">Ferret</a> index to retrieve model
class, id, score and the values of any fields stored in the index for each
hit. If a block is given, these are yielded and the number of total hits is
returned. Otherwise [<a href="LocalIndex.html#M000114">total_hits</a>,
result_array] is returned.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000116-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000116-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 98</span>
 98:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">find_id_by_contents</span>(<span class="ruby-identifier">query</span>, <span class="ruby-identifier">options</span> = {})
 99:       <span class="ruby-identifier">result</span> = []
100:       <span class="ruby-identifier">index</span> = <span class="ruby-identifier">ferret_index</span>
101:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;query: #{ferret_index.process_query query}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug?</span>
102:       <span class="ruby-identifier">lazy_fields</span> = <span class="ruby-identifier">determine_lazy_fields</span> <span class="ruby-identifier">options</span>
103: 
104:       <span class="ruby-identifier">total_hits</span> = <span class="ruby-identifier">index</span>.<span class="ruby-identifier">search_each</span>(<span class="ruby-identifier">query</span>, <span class="ruby-identifier">options</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hit</span>, <span class="ruby-identifier">score</span><span class="ruby-operator">|</span>
105:         <span class="ruby-identifier">doc</span> = <span class="ruby-identifier">index</span>[<span class="ruby-identifier">hit</span>]
106:         <span class="ruby-identifier">model</span> = <span class="ruby-identifier">aaf_configuration</span>[<span class="ruby-identifier">:store_class_name</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">doc</span>[<span class="ruby-identifier">:class_name</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">aaf_configuration</span>[<span class="ruby-identifier">:class_name</span>]
107:         <span class="ruby-comment cmt"># fetch stored fields if lazy loading</span>
108:         <span class="ruby-identifier">data</span> = {}
109:         <span class="ruby-identifier">lazy_fields</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>[<span class="ruby-identifier">field</span>] = <span class="ruby-identifier">doc</span>[<span class="ruby-identifier">field</span>] } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">lazy_fields</span>
110:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">block_given?</span>
111:           <span class="ruby-keyword kw">yield</span> <span class="ruby-identifier">model</span>, <span class="ruby-identifier">doc</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">score</span>, <span class="ruby-identifier">data</span>
112:         <span class="ruby-keyword kw">else</span>
113:           <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-identifier">:model</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">model</span>, <span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">doc</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:score</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">score</span>, <span class="ruby-identifier">:data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">data</span> }
114:         <span class="ruby-keyword kw">end</span>
115:       <span class="ruby-keyword kw">end</span>
116:       <span class="ruby-comment cmt">#logger.debug &quot;id_score_model array: #{result.inspect}&quot;</span>
117:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">block_given?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">total_hits</span> <span class="ruby-operator">:</span> [<span class="ruby-identifier">total_hits</span>, <span class="ruby-identifier">result</span>]
118:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000121" class="method-detail">
        <a name="M000121"></a>

        <div class="method-heading">
          <a href="#M000121" class="method-signature">
          <span class="method-name">highlight</span><span class="method-args">(id, class_name, query, options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
<a href="LocalIndex.html#M000121">highlight</a> search terms for the record
with the given id.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000121-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000121-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 164</span>
164:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">highlight</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">class_name</span>, <span class="ruby-identifier">query</span>, <span class="ruby-identifier">options</span> = {})
165:       <span class="ruby-identifier">options</span>.<span class="ruby-identifier">reverse_merge!</span> <span class="ruby-identifier">:num_excerpts</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>, <span class="ruby-identifier">:pre_tag</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'&lt;em&gt;'</span>, <span class="ruby-identifier">:post_tag</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'&lt;/em&gt;'</span>
166:       <span class="ruby-identifier">highlights</span> = []
167:       <span class="ruby-identifier">ferret_index</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
168:         <span class="ruby-identifier">doc_num</span> = <span class="ruby-identifier">document_number</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">class_name</span>)
169:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:field</span>]
170:           <span class="ruby-identifier">highlights</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ferret_index</span>.<span class="ruby-identifier">highlight</span>(<span class="ruby-identifier">query</span>, <span class="ruby-identifier">doc_num</span>, <span class="ruby-identifier">options</span>)
171:         <span class="ruby-keyword kw">else</span>
172:           <span class="ruby-identifier">query</span> = <span class="ruby-identifier">process_query</span>(<span class="ruby-identifier">query</span>) <span class="ruby-comment cmt"># process only once</span>
173:           <span class="ruby-identifier">aaf_configuration</span>[<span class="ruby-identifier">:ferret_fields</span>].<span class="ruby-identifier">each_pair</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">field</span>, <span class="ruby-identifier">config</span><span class="ruby-operator">|</span>
174:             <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">config</span>[<span class="ruby-identifier">:store</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">:no</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">config</span>[<span class="ruby-identifier">:highlight</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">:no</span>
175:             <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:field</span>] = <span class="ruby-identifier">field</span>
176:             <span class="ruby-identifier">highlights</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ferret_index</span>.<span class="ruby-identifier">highlight</span>(<span class="ruby-identifier">query</span>, <span class="ruby-identifier">doc_num</span>, <span class="ruby-identifier">options</span>)
177:           <span class="ruby-keyword kw">end</span>
178:         <span class="ruby-keyword kw">end</span>
179:       <span class="ruby-keyword kw">end</span>
180:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">highlights</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">flatten</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">options</span>[<span class="ruby-identifier">:num_excerpts</span>]<span class="ruby-operator">-</span><span class="ruby-value">1</span>]
181:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000117" class="method-detail">
        <a name="M000117"></a>

        <div class="method-heading">
          <a href="#M000117" class="method-signature">
          <span class="method-name">id_multi_search</span><span class="method-args">(query, models, options = {}) {|doc[:class_name], doc[:id], score, doc, data| ...}</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Queries multiple <a href="../Ferret.html">Ferret</a> indexes to retrieve
model class, id and score for each hit. Use the models parameter to give
the list of models to search. If a block is given, model, id and score are
yielded and the number of total hits is returned. Otherwise [<a
href="LocalIndex.html#M000114">total_hits</a>, result_array] is returned.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000117-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000117-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 124</span>
124:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">id_multi_search</span>(<span class="ruby-identifier">query</span>, <span class="ruby-identifier">models</span>, <span class="ruby-identifier">options</span> = {})
125:       <span class="ruby-identifier">index</span> = <span class="ruby-identifier">multi_index</span>(<span class="ruby-identifier">models</span>)
126:       <span class="ruby-identifier">result</span> = []
127:       <span class="ruby-identifier">lazy_fields</span> = <span class="ruby-identifier">determine_lazy_fields</span> <span class="ruby-identifier">options</span>
128:       <span class="ruby-identifier">total_hits</span> = <span class="ruby-identifier">index</span>.<span class="ruby-identifier">search_each</span>(<span class="ruby-identifier">query</span>, <span class="ruby-identifier">options</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hit</span>, <span class="ruby-identifier">score</span><span class="ruby-operator">|</span>
129:         <span class="ruby-identifier">doc</span> = <span class="ruby-identifier">index</span>[<span class="ruby-identifier">hit</span>]
130:         <span class="ruby-comment cmt"># fetch stored fields if lazy loading</span>
131:         <span class="ruby-identifier">data</span> = {}
132:         <span class="ruby-identifier">lazy_fields</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">field</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>[<span class="ruby-identifier">field</span>] = <span class="ruby-identifier">doc</span>[<span class="ruby-identifier">field</span>] } <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">lazy_fields</span>
133:         <span class="ruby-identifier">raise</span> <span class="ruby-value str">&quot;':store_class_name =&gt; true' required for multi_search to work&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">doc</span>[<span class="ruby-identifier">:class_name</span>].<span class="ruby-identifier">blank?</span>
134:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">block_given?</span>
135:           <span class="ruby-keyword kw">yield</span> <span class="ruby-identifier">doc</span>[<span class="ruby-identifier">:class_name</span>], <span class="ruby-identifier">doc</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">score</span>, <span class="ruby-identifier">doc</span>, <span class="ruby-identifier">data</span>
136:         <span class="ruby-keyword kw">else</span>
137:           <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> { <span class="ruby-identifier">:model</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">doc</span>[<span class="ruby-identifier">:class_name</span>], <span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">doc</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:score</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">score</span>, <span class="ruby-identifier">:data</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">data</span> }
138:         <span class="ruby-keyword kw">end</span>
139:       <span class="ruby-keyword kw">end</span>
140:       <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">block_given?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">total_hits</span> <span class="ruby-operator">:</span> [ <span class="ruby-identifier">total_hits</span>, <span class="ruby-identifier">result</span> ]
141:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000113" class="method-detail">
        <a name="M000113"></a>

        <div class="method-heading">
          <a href="#M000113" class="method-signature">
          <span class="method-name">process_query</span><span class="method-args">(query)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Parses the given query string into a <a href="../Ferret.html">Ferret</a>
Query object.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000113-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000113-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 68</span>
68:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process_query</span>(<span class="ruby-identifier">query</span>)
69:       <span class="ruby-comment cmt"># work around ferret bug in #process_query (doesn't ensure the</span>
70:       <span class="ruby-comment cmt"># reader is open)</span>
71:       <span class="ruby-identifier">ferret_index</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
72:         <span class="ruby-identifier">ferret_index</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">:ensure_reader_open</span>)
73:         <span class="ruby-identifier">original_query</span> = <span class="ruby-identifier">ferret_index</span>.<span class="ruby-identifier">process_query</span>(<span class="ruby-identifier">query</span>)
74:       <span class="ruby-keyword kw">end</span>
75:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000123" class="method-detail">
        <a name="M000123"></a>

        <div class="method-heading">
          <a href="#M000123" class="method-signature">
          <span class="method-name">query_for_record</span><span class="method-args">(id, class_name = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
build a ferret query matching only the record with the given id the class
name only needs to be given in case of a shared index configuration
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000123-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000123-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 192</span>
192:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">query_for_record</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">class_name</span> = <span class="ruby-keyword kw">nil</span>)
193:       <span class="ruby-constant">Ferret</span><span class="ruby-operator">::</span><span class="ruby-constant">Search</span><span class="ruby-operator">::</span><span class="ruby-constant">TermQuery</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:id</span>, <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>)
194:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000111" class="method-detail">
        <a name="M000111"></a>

        <div class="method-heading">
          <a href="#M000111" class="method-signature">
          <span class="method-name">rebuild_index</span><span class="method-args">(*models)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
rebuilds the index from all records of the model class this index belongs
to. Arguments can be given in shared index scenarios to name multiple model
classes to include in the index
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000111-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000111-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 51</span>
51:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">rebuild_index</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">models</span>)
52:       <span class="ruby-identifier">models</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">aaf_configuration</span>[<span class="ruby-identifier">:class_name</span>] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">models</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">aaf_configuration</span>[<span class="ruby-identifier">:class_name</span>])
53:       <span class="ruby-identifier">models</span> = <span class="ruby-identifier">models</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:constantize</span>)
54:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;rebuild index: #{models.inspect}&quot;</span>
55:       <span class="ruby-identifier">index</span> = <span class="ruby-constant">Ferret</span><span class="ruby-operator">::</span><span class="ruby-constant">Index</span><span class="ruby-operator">::</span><span class="ruby-constant">Index</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">aaf_configuration</span>[<span class="ruby-identifier">:ferret</span>].<span class="ruby-identifier">dup</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">:auto_flush</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>, 
56:                                                                              <span class="ruby-identifier">:field_infos</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">ActsAsFerret</span><span class="ruby-operator">::</span><span class="ruby-identifier">field_infos</span>(<span class="ruby-identifier">models</span>),
57:                                                                              <span class="ruby-identifier">:create</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>))
58:       <span class="ruby-identifier">index</span>.<span class="ruby-identifier">batch_size</span> = <span class="ruby-identifier">aaf_configuration</span>[<span class="ruby-identifier">:reindex_batch_size</span>]
59:       <span class="ruby-identifier">index</span>.<span class="ruby-identifier">logger</span> = <span class="ruby-identifier">logger</span>
60:       <span class="ruby-identifier">index</span>.<span class="ruby-identifier">index_models</span> <span class="ruby-identifier">models</span>
61:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000120" class="method-detail">
        <a name="M000120"></a>

        <div class="method-heading">
          <a href="#M000120" class="method-signature">
          <span class="method-name">remove</span><span class="method-args">(id, class_name)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
delete record from index
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000120-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000120-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 159</span>
159:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">remove</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">class_name</span>)
160:       <span class="ruby-identifier">ferret_index</span>.<span class="ruby-identifier">query_delete</span> <span class="ruby-identifier">query_for_record</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">class_name</span>)
161:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000107" class="method-detail">
        <a name="M000107"></a>

        <div class="method-heading">
          <a href="#M000107" class="method-signature">
          <span class="method-name">reopen!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000107-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000107-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 10</span>
10:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">reopen!</span>
11:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@ferret_index</span>
12:         <span class="ruby-ivar">@ferret_index</span>.<span class="ruby-identifier">close</span>
13:         <span class="ruby-ivar">@ferret_index</span> = <span class="ruby-keyword kw">nil</span>
14:       <span class="ruby-keyword kw">end</span>
15:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;reopening index at #{aaf_configuration[:ferret][:path]}&quot;</span>
16:       <span class="ruby-identifier">ferret_index</span>
17:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000114" class="method-detail">
        <a name="M000114"></a>

        <div class="method-heading">
          <a href="#M000114" class="method-signature">
          <span class="method-name">total_hits</span><span class="method-args">(query, options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Total number of hits for the given query. To count the results of a
multi_search query, specify an array of class names with the :multi option.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000114-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000114-source">
<pre>
    <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 80</span>
80:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">total_hits</span>(<span class="ruby-identifier">query</span>, <span class="ruby-identifier">options</span> = {})
81:       <span class="ruby-identifier">index</span> = (<span class="ruby-identifier">models</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:multi</span>)) <span class="ruby-operator">?</span> <span class="ruby-identifier">multi_index</span>(<span class="ruby-identifier">models</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">ferret_index</span>
82:       <span class="ruby-identifier">index</span>.<span class="ruby-identifier">search</span>(<span class="ruby-identifier">query</span>, <span class="ruby-identifier">options</span>).<span class="ruby-identifier">total_hits</span>
83:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Protected Instance methods</h3>

      <div id="method-M000124" class="method-detail">
        <a name="M000124"></a>

        <div class="method-heading">
          <a href="#M000124" class="method-signature">
          <span class="method-name">multi_index</span><span class="method-args">(model_classes)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
returns a <a href="MultiIndex.html">MultiIndex</a> instance operating on a
MultiReader
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000124-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000124-source">
<pre>
     <span class="ruby-comment cmt"># File vendor/plugins/acts_as_ferret/lib/local_index.rb, line 200</span>
200:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">multi_index</span>(<span class="ruby-identifier">model_classes</span>)
201:       <span class="ruby-identifier">model_classes</span>.<span class="ruby-identifier">map!</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:constantize</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">model_classes</span>.<span class="ruby-identifier">first</span>
202:       <span class="ruby-identifier">model_classes</span>.<span class="ruby-identifier">sort!</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span>, <span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">name</span> }
203:       <span class="ruby-identifier">key</span> = <span class="ruby-identifier">model_classes</span>.<span class="ruby-identifier">inject</span>(<span class="ruby-value str">&quot;&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span>, <span class="ruby-identifier">clazz</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">clazz</span>.<span class="ruby-identifier">name</span> }
204:       <span class="ruby-identifier">multi_config</span> = <span class="ruby-identifier">aaf_configuration</span>[<span class="ruby-identifier">:ferret</span>].<span class="ruby-identifier">dup</span>
205:       <span class="ruby-identifier">multi_config</span>.<span class="ruby-identifier">delete</span> <span class="ruby-identifier">:default_field</span>  <span class="ruby-comment cmt"># we don't want the default field list of *this* class for multi_searching</span>
206:       <span class="ruby-constant">ActsAsFerret</span><span class="ruby-operator">::</span><span class="ruby-identifier">multi_indexes</span>[<span class="ruby-identifier">key</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">MultiIndex</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">model_classes</span>, <span class="ruby-identifier">multi_config</span>)
207:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>