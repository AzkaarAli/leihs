h = render(:partial => "contracts/contract_line.json.rjson", :locals => {:line => line, :with => with})

if with ||= nil
  if with[:availability]
    if (customer_user = with[:availability][:user])
      h[:total_borrowable] = line.model.total_borrowable_items_for_user(customer_user)
      h[:availability_for_user] = line.model.availability_periods_for_user(customer_user)
    end
  end
end

h
