h = line.as_json
h[:model] = line.model.as_json(:methods => :package_models) # FIXME move package_models down to item_line ??

if with ||= nil
  if with[:contract]
    h[:contract] = line.contract.as_json(:include => {:user => {:only => [:firstname, :lastname]}})
    h[:type] = (line.contract.status_const == 1) ? "hand_over_line" : "take_back_line"
  end
end

h
