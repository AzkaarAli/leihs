%form.availability
  %input#date_from.date.start{:name => "startdate", :value => Date.today, :title => _("Start Date")}
  = "-"
  %input#date_to.date.end{:name => "enddate", :value => Date.tomorrow, :title => _("End Date")}
  .checkarea
    %input#available-only.check{:type => "checkbox", :name => "available-only", :value => "available-only"}
    %label{:for => "available-only", :title => _("Show Available")}
      = _("Available")
 
:javascript

  $(document).ready(function(){
      AvSelector.setup();
  });
  
  var AvSelector = new AvSelector();
  
  function AvSelector() {
    
    this.start_date;
    this.end_date;
    
    this.setup = function() {
      
      $.datepicker.setDefaults(i18n.selected.datepicker);
      
      this.formatDates();
      
      var dates = $('#topfilter .availability .date').datepicker({
        minDate: 0,
        showOtherMonths: true,
        selectOtherMonths: true,
        showButtonPanel: true,
        onClose: function(selectedDate, instance) {
          var option = this.id == "date_from" ? "minDate" : "maxDate",
              date = $.datepicker.parseDate(instance.settings.dateFormat || $.datepicker._defaults.dateFormat, selectedDate, instance.settings );
          dates.not( this ).datepicker( "option", option, date );
  
          AvSelector.update();
        }
      });
  
      AvSelector.update();
      
    }
    
    this.formatDates = function() {
      $('#topfilter .availability .date').each(function(){
        var date = new Date($(this).val());
        $(this).val(formatDate(date, $.datepicker.regional[''].dateFormat.replace(/m/g, "M"))); //note different convention between jquery dateFormat and normal dateFormat
      });
    }
    
    this.update = function() {
      var sd = $("#date_from").datepicker("getDate").getTime() / 1000;
      var ed = $("#date_to").datepicker("getDate").getTime() / 1000;
      
      $("[data-availability]").each(function(){
        var availability_ips = $(this).data('availability');
        // TODO filter active inventory_pools
        var min_ips = $.map(availability_ips, function(elem){
          var min = 0;
          var to_min = [];
          var f1 = elem.availability.filter(function(x){ return (x[0] < sd); });
          if(f1.length) to_min.push(f1[f1.length-1][1]);
          var f2 = elem.availability.filter(function(x){ return (sd <= x[0] && x[0] <= ed); });
          if(f2.length) to_min.push(Math.min.apply(Math, $.map(f2, function(x){ return x[1]; })));
          if(to_min.length) min = Math.min.apply(Math, to_min);
          return Math.max.apply(Math, [min, 0]);
        });
        // TODO get min, max or sum ???
        var absolute_min = Math.min.apply(Math, min_ips);
        $(this).html(absolute_min);
        //var max_from_one_ip = Math.max.apply(Math, min_ips);
        //$(this).html(max_from_one_ip);
      });
    }
  }