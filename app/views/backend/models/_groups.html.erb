<% content_tag :h3 do %>
	<%= _("Current group quantities") %>
<% end %>

<%
borrowable_items = current_inventory_pool.items.borrowable.scoped_by_model_id(@model).count
unborrowable_items = current_inventory_pool.items.unborrowable.scoped_by_model_id(@model).count

form_tag set_group_partition_backend_inventory_pool_model_path(current_inventory_pool, @model) do
	content_tag :table, :id => "groups" do
		content_tag :tr do
			content_tag :th do %>
			<% end
			content_tag :th do %>
				<%= _("Borrowable (%d)") % borrowable_items %>
			<% end
			content_tag :th do %>
				<%= _("Unborrowable (%d)") % unborrowable_items %>
			<% end
		end
		content_tag :tr do
			content_tag :td do %>
				<%= _("General") %>:
			<% end
			content_tag :td, :id => "general_in_stock" do %>
				<%= @model.partitions.in(current_inventory_pool).by_group(Group::GENERAL_GROUP_ID) %>
			<% end
			content_tag :td do %>
			<% end
		end
		current_inventory_pool.groups.each do |group|
			content_tag :tr do
				content_tag :td do %>
					<%= group %>:
				<% end
				content_tag :td do
					quantity = @model.partitions.in(current_inventory_pool).by_group(group).try(:quantity).to_i %>
					<%= text_field_tag "groups[#{group.id}]", quantity, :autocomplete => "off" %>
				<% end
				content_tag :td do %>
				<% end
			end
		end
	end %>
	
	<%= submit_tag _("Submit") %>		
<% end %>

<%
# automatically computes the rest quantity for the general group
# rest = borrowable_items - allocated_items_to_groups
javascript_tag do %>
	jQuery(document).ready(function($){
		var general_in_stock = $("td#general_in_stock");
		$("#groups input").keyup(function(){
			var rest = <%= borrowable_items %>;
			$("#groups input").each(function(){
				var val = $(this).val() * 1; 
				rest -=  val;
				(val < 0 ? $(this).addClass("valid_false") : $(this).removeClass("valid_false"));
			});
			general_in_stock.html(String(rest));
			(rest < 0 ? general_in_stock.addClass("valid_false") : general_in_stock.removeClass("valid_false"));
		});
	});
<% end %>

<%= availability_changes(@availability) %>
