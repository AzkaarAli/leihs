%tr.alt-row
  %td
    -# working here TODO async post
    - check_box_today = @line.start_date <= Date.today ? "contract_line_check_today" : ""
    - is_checked = @line.complete?
    = check_box_tag 'contract_lines[]', @line.id, is_checked,
                    :class    => "contract_line_check #{check_box_today}",
                    :onchange => "toggle_buttons('contract_line_check', 'ghostable_group_1');"
    
    = text_field :line, :quantity,                                                            |
                 :id       =>"line_quantity_#{@line.id}", :size => 3,                         |
                 :onchange => remote_function( :url  => { :action => 'change_line_quantity',  |
                                                          :contract_line_id => @line.id },    |
                                               :with => "'quantity=' + value" )               |
    
    - if @line.model.internal_description and not @line.model.internal_description.blank?
      - tooltip icon_tag("information") do
        = @line.model.internal_description
    
    = allocated_group(@line)

  %td
    = show_line_model(@line.model)
    
    - unless @line.model.nil? or @line.model.hand_over_note.blank?
      .hand_over_note
        = @line.model.hand_over_note

  -# TODO optimize, async post ??
  - b = @line.available? # true/false
  %td{ :class => "valid_#{b}" }
    -# TODO: optimize! :
    = greybox_link_to_page( dates_with_period(@line.start_date, @line.end_date),
                            { :action => 'time_lines', :lines => @line.id },
                            :class => "thickbox iconized-notxt date-edit",
                            :id => "dates_\#{@line.id}",
                            :title => _("Time Period") )

  - b = !@line.item.nil? # true/false
  %td{ :class => "valid_#{b}", :id => "inventory_code_#{@line.id}"}
    - @item = @line.item
    - @item_inventory_code = (@item ? @item.inventory_code : "")

    -# TODO: optimize! :
    = text_field :item, :inventory_code,                                 |
        { :id           => "line_item_inventory_code_#{@line.id}",       |
          :size         => 10,                                           |
          :autocomplete => false,                                        |
          :onclick      => "do_autocomplete(this)",                      |
          :onfocus      =>                                               | 
            "on_item_code_input_focus(this, '#{@item_inventory_code}')", |
          :onblur       => "this.onfocus()",                             |
          :onchange     => "this.onfocus()"                              |
        }                                                                |

    .smaller{ :id => "line_item_location_#{@line.id}" }
      = @line.item.location if @line.item

    .autocomplete{ :id    => "line_item_inventory_code_#{@line.id}_list",   |
                   :style => "display:none;min-width: 300px;"             } |

    -# OPTIMIZE
    - items = current_inventory_pool.items.in_stock.scoped_by_model_id(@line.model)
    - styled_inventory_codes = items.collect do |i|
      - if i.location
        - additional_info = "<br><span class='informal'>#{i.location}</span>"
      - style = i.is_borrowable? ? '%s' : '<span style="color:red;">%s</span>'
      - "#{style % i.inventory_code}#{additional_info}"

    :javascript
      styled_inventory_codes['#{@line.id}'] = #{styled_inventory_codes.to_json};
    
    - if @line.item and @line.item.needs_permission?
      - tooltip icon_tag('stop') do
        = _("Item needs permission!")

  %td.buttons
    = greybox_link_to_page( icon_tag("arrow_switch") + " " + _("Swap"),
                            { :action => 'swap_model_line', :line_id => @line.id },
                            :title => _("Swap Model") )
    = greybox_link_to_page( icon_tag("cancel") + " " + _("Delete"),
                            { :action => 'remove_lines', :lines => @line.id },
                              :title => _("Remove Model"), :class => 'negative' )
